# 工作流的名称
name: Fedora Environment and Shell Test (ARM64)

# 触发工作流的事件
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# 定义一个名为 'test' 的任务
jobs:
  test-fedora-arm64:
    # 任务在 'ubuntu-latest' 虚拟机上运行，但会通过 QEMU 模拟 ARM64
    runs-on: ubuntu-latest

    steps:
      # 第一步：检出你的代码仓库
      - name: Checkout Repository
        uses: actions/checkout@v5

      # 第二步：使用 run-on-arch-action 在 Fedora ARM64 容器中运行命令
      - name: Display Fedora ARM64 Environment and Shell Details
        uses: uraimo/run-on-arch-action@v3
        with:
          # 指定架构为 ARM64
          arch: aarch64
          # 指定操作系统为 Fedora 最新版
          distro: fedora_latest
          # 这里的所有命令都会在 Fedora ARM64 环境中执行
          run: |
            echo "--- Fedora ARM64 Environment ---"
            echo "OS Version:"
            cat /etc/os-release
            echo "Kernel Info:"
            uname -a
            uname -m
            echo "--- CPU Brand String ---"
            # 注意：在 QEMU 模拟环境中，/proc/cpuinfo 可能不会显示真实的 CPU 品牌
            echo "CPU brand string might be generic due to QEMU emulation."
            cat /proc/cpuinfo | grep "model name" | head -n 1 | awk -F': ' '{print $2}'
            echo "--- IP Info ---"
            hostname -I | cut -d' ' -f1
            echo "Current User:"
            whoami
            echo "Default Shell:"
            echo $SHELL

      # 第三步：执行一些 Shell 命令
      - name: Run a few Shell Commands
        uses: uraimo/run-on-arch-action@v3
        with:
          # 指定架构为 ARM64
          arch: aarch64
          # 指定操作系统为 Fedora 最新版
          distro: fedora_latest
          # 这里的所有命令都会在 Fedora ARM64 环境中执行
          run: |
            echo "Listing files in current directory:"
            ls -la
            echo "--- sh Info ---"
            type -a sh
            sh --version
            echo "--- bash Info ---"
            type -a bash
            bash --version
            echo "--- zsh Info ---"
            ! type zsh &>/dev/null && dnf install -y zsh || echo "zsh installed"
            type -a zsh
            zsh --version
            echo "--- util-linux ---"
            ! type chsh &>/dev/null && dnf install -y util-linux || echo "util-linux installed"
            type -a chsh
            chsh --version

      # 第四步：执行一个脚本文件
      # ⚠️ 注意：这个步骤仍将使用 run-on-arch-action 在模拟环境中运行
      - name: Run a custom shell script
        uses: uraimo/run-on-arch-action@v3
        with:
          arch: aarch64
          distro: fedora_latest
          run: |
            echo "Executing test_script.sh from the repository..."
            # 确保脚本文件有执行权限
            chmod +x ./test_script.sh
            # 运行脚本
            ./test_script.sh
